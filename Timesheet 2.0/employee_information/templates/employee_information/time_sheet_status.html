{% extends "employee_information/base.html" %} {% block pageContent %}
<style>
    .highlight-row{
        background-color: #e0e0e0 !important;
        height: 35px;
        border-color: white;

    }
    .highlight-row td {
    line-height: 8px;
    border-top: 1px solid transparent; /* Adjust this value */
    border-bottom: 1px solid transparent; /* Adjust this value */
    vertical-align: middle; /* To align the text vertically in the middle */
}
    .italic-text {
        
        white-space: nowrap;
    }
    .spaced-table {
        border-collapse: separate;
        border-spacing: 0 5px;
    }
    .spaced-table th {
        color: white !important;
    }
    .button-group {
    display: flex;
    justify-content: flex-end;
    }

    .message-box {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: black;
        color: white;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .message-box.show {
        opacity: 1;
        display: block;
        animation: fadeOut 0.5s ease-in-out;
    }
    @keyframes fadeOut {
        0% {
            opacity: 1;
        }
        100% {
            opacity: 0;
        }
}
</style>
<div class="italic-text">
    <h2> Time Sheet Status</h2>
</div>
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card py-2" style="background-color: #dcd0ff;">
        <div class="d-flex justify-content-start align-items-center">
            <label for="start_date" class="me-2">Start Date </label>
            <input type="date" id="start_date" name="start_date" class="me-4">
            <label for="end_date" class="me-2">End Date</label>
            <input type="date" id="end_date" name="end_date" class="me-5">
            <button type="button" id="applyFilterBtn" class="btn btn-primary">Apply Filter</button>
        </div>
    </div>
</div>
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card">
        <div class="table-responsive">
            <form id="timeSheetForm">
            <table class="table table-bordered spaced-table">
                <colgroup>
                    <col width="15%">
                    <col width="11.5%">
                    <col width="11.5%">
                    <col width="11.5%">
                    <col width="11.5%">
                    <col width="11.5%">
                    <col width="11.5%">
                    <col width="11.5%">
                </colgroup>
                <thead style="height: 10px;" >
                    <tr style="background-color: grey;">
                        <th class="text-center ">Project name</th>
                        <th class="text-center ">Emp id</th>
                        <th class="text-center ">Start Date</th>
                        <th class="text-center ">End Date</th>
                        <th class="text-center ">ST</th>
                        <th class="text-center ">OT</th>
                        <th class="text-center ">Status</th>
                        <th class="text-center ">Approved By</th>
                    </tr>
                </thead>
                <tbody>
                    
                    {% for position in data_result %}    
                        <tr class="highlight-row" >
                        <td class=" text-center">{{ position.project_name }}</td>
                        
                        <td class=" text-center">{{ position.username }}</td>
                        <td class=" text-center">{{ position.start_date }}</td>
                        <td class=" text-center">{{ position.end_date }}</td>
                        <td class=" text-center">{{ position.St }}</td>
                        <td class=" text-center">{{ position.ot }}</td>
                        {% if position.status and position.status != " " %}
                        <td class=" text-center">{{ position.status }}</td>
                        {% else %}
                        <td class=" text-center">Pending</td>
                        {% endif %}
                        {% if position.Approved_by %}
                        <td class=" text-center">Manager</td>
                        {% else %}
                        <td class=" text-center">Manager</td>
                        {% endif %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        </form>
        <div id="pagination" style="text-align: right;">
            <span id="pageDisplay">Page 1</span>
            <button id="prevBtn" disabled><</button>
            <button id="nextBtn">></button>
            <button type="button" id="saveBtn" class="btn btn-primary" style="float: left; margin-right: 10px;">Download List Data</button>
        </div>
    </div>
</div>
{% endblock pageContent %} {% block ScriptBlock %}

<script>
    document.getElementById('applyFilterBtn').addEventListener('click', function() {
        var startDate = document.getElementById('start_date').value;
        var endDate = document.getElementById('end_date').value;

        fetch("{% url 'time_sheet_status' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                'start_date': startDate,
                'end_date': endDate
            })
        }).then(function(response) {
            return response.json();
        }).then(function(data_result) {
            var tableBody = document.querySelector('.table tbody');
            var currentPage = 0;
            var rowsPerPage = 10;

            function displayPage() {
                while (tableBody.firstChild) {
                    tableBody.removeChild(tableBody.firstChild);
                }

                var start = currentPage * rowsPerPage;
                var end = start + rowsPerPage;

                data_result.slice(start, end).forEach(function(item) {
                    var row = document.createElement('tr');
                    row.classList.add('highlight-row')
                    row.innerHTML = `
                        <td class="text-center">${item.project_name}</td>
                        <td class="text-center">${item.username}</td>
                        <td class="text-center">${item.start_date}</td>
                        <td class="text-center">${item.end_date}</td>
                        <td class="text-center">${item.St}</td>
                        <td class="text-center">${item.ot}</td>
                        <td class="text-center">
                            ${item.status == "Approved" || item.status == "Rejected" ? item.status : 
                                "Pending"
                            }
                        </td>
                        
                        <td class="px-2 py-1 text-center">Manager</td>
                    `;
                    tableBody.appendChild(row);
                });

                document.getElementById('pageDisplay').textContent = 'Page ' + (currentPage + 1);

                var prevBtn = document.getElementById('prevBtn');
                var nextBtn = document.getElementById('nextBtn');

                if (currentPage === 0) {
                    prevBtn.disabled = true;
                } else {
                    prevBtn.disabled = false;
                }

                if (end >= data.length) {
                    nextBtn.disabled = true;
                } else {
                    nextBtn.disabled = false;
                }
            }

            displayPage();

            document.getElementById('prevBtn').addEventListener('click', function() {
                currentPage--;
                displayPage();
            });

            document.getElementById('nextBtn').addEventListener('click', function() {
                currentPage++;
                displayPage();
            });
        }).catch(function(error) {
            console.error('Error:', error);
        });
    });
    document.getElementById('saveBtn').addEventListener('click', function() {
    // Get the table element
    var table = document.querySelector('.table');

    // Get the table rows
    var rows = table.querySelectorAll('tbody tr');

    // Create an array to store the table data
    var tableData = [];

    // Iterate over each row and extract the cell values
    rows.forEach(function(row) {
        var rowData = [];
        var cells = row.querySelectorAll('td');
        cells.forEach(function(cell) {
            rowData.push(cell.textContent.trim());
        });
        tableData.push(rowData);
    });

    // Create a JSON object with the table data
    var jsonData = {
        'table_data': tableData
    };
    
    // Send the table data to the server using an AJAX request
    fetch("{% url 'download_list_data' %}", {
    method: 'POST',
    body: JSON.stringify(jsonData),
    headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'  // Include CSRF token if needed

    }
})
.then(response => response.blob())
.then(blob => {
    // Create a new object URL for the blob
    const url = window.URL.createObjectURL(blob);

    // Create a link and click it to start the download
    const link = document.createElement('a');
    link.href = url;
    link.download = 'list_data.csv';
    link.click();

    // Release the reference to the object URL
    window.URL.revokeObjectURL(url);
});
});
</script>
{% endblock ScriptBlock %}

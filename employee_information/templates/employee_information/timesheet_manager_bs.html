{% extends "employee_information/base.html" %} {% block pageContent %}

<div class="container" style="margin-top: 5%">
  <div class="row">
    <div class="col-12">
      <h1></h1>
      <h2 class="fw-bold mb-4">TimeSheet Status</h2>
    </div>
  </div>
  <div class="row">
    <h1></h1>
  </div>
  <div class="row mx-auto" style="background-color: #ecd5ef; min-height: 7%">
    <div class="col-auto my-auto">
      <select id="filter" name="status" class="form-select fw-medium text-center" style="background-color: transparent; border: none;">
        <option value="project_name">Project Name</option>
        <option value="emp_name">Employee Name</option>
        <option value="start_date">Date</option>
      </select>
    </div>
    <div class="col-auto my-auto">
      <input type="text" id="project_name_filter" class="form-control" />
    </div>
    <div class="col-auto my-auto ms-3">
      <button
        class="btn btn-sm text-light px-3"
        style="background-color: #4981b2 !important"
        id="applyFilterBtn"
      >
        Apply Filters
      </button>
    </div>
  </div>
  <div class="row mt-5 mx-auto">
    <table class="table table-responsive table-bordered">
      <thead>
        <tr class="table-secondary fw-light">
          <th class="fw-medium text-center">Project Name</th>
          <th class="fw-medium text-center">Employee Name</th>
          <th class="fw-medium text-center">Start Date</th>
          <th class="fw-medium text-center">End Date</th>
          <th class="fw-medium text-center">ST</th>
          <th class="fw-medium text-center">OT</th>
          <th class="fw-medium text-center">Status</th>
          <th class="fw-medium text-center">Comment</th>
          <th class="fw-medium text-center"></th>
        </tr>
      </thead>
      {% for position in data|slice:":5" %}
      <tr>
        <td id="project_name" class="text-center">{{ position.project_name }}</td>
        <td id="username" class="text-center">{{ position.username }}</td>
        <td id='start_date' class="text-center">{{ position.start_date }}</td>
        <td id='end_date' class="text-center">{{ position.end_date }}</td>
        <td id='St' class="text-center">{{ position.St }}</td>
        <td id='ot' class="text-center">{{ position.ot }}</td>
        {% if position.status == "Approved" %}
          <td id="status" class="text-center">Approved</td>
        {% elif position.status == "Rejected" %}
          <td id="status" class="text-center">Rejected</td>
        {% elif position.status == "uncheck" %}
          <td id="status" class="text-center">uncheck</td>
        {% else %}
          <td id="status" class="text-center">
            <select name="status" style="background-color: transparent; border: none;">
              <option value="Approved">Approved</option>
              <option value="Rejected">Rejected</option>
              <option value="uncheck">Uncheck</option>
            </select>
          </td>
        {% endif %} 
        <td>
          <div class="form-group">
            <textarea id="comment" name="review_comments" rows="2" cols="15" class="form-control">{{ position.comments }}</textarea>
          </div>
        </td>
        <td class="text-center">
          {% if position.status == "Approved" or position.status == "Rejected" or position.status == "uncheck" %}
            <button id="send-btn" type="button" class="btn btn-success btn-sm undo-btn">Success</button> 
          {% else %}
          <button id="send-btn" type="button" class="btn btn-danger btn-sm">Submit</button>
          {% endif %}
          <button id = "visibility" class="btn btn-secondary btn-sm edit-data" type="button" data-id="{{ employee.employee_id }}" title="Edit">
            <i class="fa-solid fa-pen"></i>
          </button>
        </td>
      </tr>
      {% endfor %}
      
    </table>
  </div>
  <div class="row">
    <div class="col-auto me-auto">
        <button class="btn btn-md text-light" id="saveBtn" style="background-color: #978d9a">
            Download List Data
        </button>
    </div>
    <div class="col-auto ms-auto" id="pagination" style="text-align: right;">
      {% if data.has_previous %}
          <button onclick="location.href='?page={{ data.previous_page_number }}'"><</button>
      {% endif %}
      <span id="pageDisplay">Page {{ data.number }} of {{ data.paginator.num_pages }}</span>
      {% if data.has_next %}
          <button onclick="location.href='?page={{ data.next_page_number }}'">></button>
      {% endif %}
  </div>
    
</div>

</div>
<script>
  //download button
  document.getElementById('saveBtn').addEventListener('click', function() {
    // Get the table element
    var table = document.querySelector('.table');

    // Get the table rows
    var rows = table.querySelectorAll('tbody tr');

    // Create an array to store the table data
    var tableData = [];

    // Iterate over each row and extract the cell values
    rows.forEach(function(row) {
        var rowData = [];
        var cells = row.querySelectorAll('td');
        cells.forEach(function(cell) {
            rowData.push(cell.textContent.trim());
        });
        tableData.push(rowData);
    });

    // Create a JSON object with the table data
    var jsonData = {
        'table_data': tableData
    };
    
    // Send the table data to the server using an AJAX request
    fetch("{% url 'download_list_data' %}", {
    method: 'POST',
    body: JSON.stringify(jsonData),
    headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'  // Include CSRF token if needed

    }
})
.then(response => response.blob())
.then(blob => {
    // Create a new object URL for the blob
    const url = window.URL.createObjectURL(blob);

    // Create a link and click it to start the download
    const link = document.createElement('a');
    link.href = url;
    link.download = 'list_data.csv';
    link.click();

    // Release the reference to the object URL
    window.URL.revokeObjectURL(url);
});
});
</script>
<script>
  // Filter start date change, disabling filter button
  document.getElementById('filter').addEventListener('change', function() {
    var selectedOption = this.value;
    var nextInputField = document.getElementById('project_name_filter');
    if (selectedOption === 'start_date') {
        nextInputField.type = 'date';
    } else {
        nextInputField.type = 'text';
    }
});

document.getElementById('project_name_filter').addEventListener('input', function() {
    var projectName = this.value;
    var applyFilterBtn = document.getElementById('applyFilterBtn');
    if (projectName.trim() !== '') {
        applyFilterBtn.disabled = false;
    } else {
        applyFilterBtn.disabled = true;
    }
});
  
</script>
<script>
  //filter button, submit button
  document.getElementById('applyFilterBtn').addEventListener('click', function() {
        var value = document.getElementById('project_name_filter').value;
        var projectDropdown = document.getElementById('filter');
        var project_name = projectDropdown.value;
        console.log(project_name)
        if (project_name == "emp_name"){
            data = {
                "selected": "emp_name",
                "project_name": value
            }
        }
        else if (project_name == "project_name"){
            data = {
                "selected": "project_name",
                "project_name": value
            }
        }
        else{
            data = {
                "selected": "start_date",
                "project_name": value
            }
        }

        
        fetch("{% url 'timesheet_manager' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data) // Add closing parenthesis here
        }).then(function(response) {
            return response.json();
        }).then(function(data_list) { // Move the .then function call here
            
            var tableBody = document.querySelector('.table tbody');
            var currentPage = 0;
            var rowsPerPage = 10;

            function displayPage() {
                console.log("second displaypage callled")
                while (tableBody.firstChild) {
                    tableBody.removeChild(tableBody.firstChild);
                }

                var start = currentPage * rowsPerPage;
                var end = start + rowsPerPage;

                data_list.slice(start, end).forEach(function(item) {
                    $(document).on('click', '.edit-data', function() {
                        console.log("hey")
                        var id = $(this).attr('data-id');
                        var project = $(this).attr('data-project');
                        var startDate = $(this).attr('data-start_date');
                        var endDate = $(this).attr('data-end_date');
                        
                        // Call the uni_modal function with the appropriate parameters
                        uni_modal("Edit TimeSheet", "{% url 'view_timesheet' %}?id=" + id + "&data-project=" + project + "&data-start_date=" + startDate + "&data-end_date=" + endDate, 'modal-lg');
                    });
                    var row = document.createElement('tr');
                    console.log(item.project_name,item.username, item.start_date, item.end_date);

                    //row.classList.add('highlight-row')
                    row.innerHTML = `
                        <td id="project_name" class="text-center">${item.project_name}</td>
                        <td id="username" class="text-center">${item.username}</td>
                        <td id='start_date' class="text-center">${item.start_date}</td>
                        <td id='end_date' class="text-center">${item.end_date}</td>
                        <td id='St' class="text-center">${item.St}</td>
                        <td id='ot' class="text-center">${item.ot}</td>
                        <td class="text-center">
                            ${item.status == "Approved" || item.status == "Rejected" || item.status == "uncheck" ? item.status : `
                            <select name="status" style="background-color: transparent; border: none;">
                              <option value="Approved">Approved</option>
                              <option value="Rejected">Rejected</option>
                              <option value="uncheck">Uncheck</option>
                            </select>
                            `}
                        </td>
                        <td> 
                          <div class="form-group">
                            <textarea id="comment" name="review_comments" rows="2" cols="15" class="form-control">${item.comments}</textarea>
                          </div>  
                         </td>
                        <td class="text-center">
                            ${item.status == "Approved" || item.status == "Rejected" ? 
                            `<button id="send-btn" class="undo-btn" style="background-color: green !important; color: white; border: none; padding: 3px 5px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); transition: background-color 0.3s;" disabled>SEND</button>` :
                            `<button id="send-btn" onclick="submitForm(event)" style="background-color: red !important; color: white; border: none; padding: 3px 5px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); transition: background-color 0.3s;">SEND</button>`}
                            <button id="visibility" class="mdc-button mdc-button--raised p-1 icon-button filled-button--light mdc-ripple-upgraded edit-data" type="button" data-id="${item.username}" data-project="${item.project_name}" data-start_date="${item.start_date}" data-end_date="${item.end_date}" title="Edit">
                                <i class="material-icons mdc-button__icon">visibility</i>
                            </button>

                            {% if position.status == "Approved" or position.status == "Rejected" or position.status == "uncheck" %}
                              <button id="send-btn" type="button" class="btn btn-success btn-sm undo-btn">Success</button> 
                            {% else %}
                            <button id="send-btn" type="button" class="btn btn-danger btn-sm">Submit</button>
                            {% endif %}
                            <button id = "visibility" class="btn btn-secondary btn-sm edit-data" type="button" data-id="{{ employee.employee_id }}" title="Edit">
                              <i class="fa-solid fa-pen"></i>
                            </button>
                        </td>
                        
                    `;
                    tableBody.appendChild(row);
                });

                document.getElementById('pageDisplay').textContent = 'Page ' + (currentPage + 1);

                var prevBtn = document.getElementById('prevBtn');
                var nextBtn = document.getElementById('nextBtn');

                if (currentPage === 0) {
                    prevBtn.disabled = true;
                } else {
                    prevBtn.disabled = false;
                }

                if (end >= data_list.length) {
                    nextBtn.disabled = true;
                } else {
                    nextBtn.disabled = false;
                }
            }

            displayPage();

            document.getElementById('prevBtn').addEventListener('click', function() {
                currentPage--;
                displayPage();
            });

            document.getElementById('nextBtn').addEventListener('click', function() {
                currentPage++;
                displayPage();
            });
        }).catch(function(error) {
            console.error('Error:', error);
        });
    });


    function submitForm(event) {
        event.preventDefault(); // Prevent form submission and page refresh

        var button = event.target;
        var row = button.parentNode.parentNode;
        var data = {
        'project_name': row.querySelector('td:nth-child(1)')?.innerText || '',
        'username': row.querySelector('td:nth-child(2)')?.innerText || '',
        'start_date': row.querySelector('td:nth-child(3)')?.innerText || '',
        'end_date': row.querySelector('td:nth-child(4)')?.innerText || '',
        'ST': row.querySelector('td:nth-child(5)')?.innerText || '',
        'OT': row.querySelector('td:nth-child(6)')?.innerText || '',
        'status': row.querySelector('td:nth-child(7) select')?.value || '',
        'comment': row.querySelector('td:nth-child(8) input')?.value || '',
        
    };

        fetch("{% url 'timesheet_manager' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        }).then(function(response) {
        return response.json();
        }).then(function(data) {
            if (data.message === "Update successful") {
                button.style.backgroundColor = "green";
                button.textContent = "Undo";

                // Find the status field and update it
                var statusField = row.querySelector('td:nth-child(7)');
                if (data.status){
                statusField.innerHTML = data.status;} // Assuming the server returns the new status
                else if (data.data){
                    statusField.innerHTML = data.data;}
                else {
                    statusField.innerHTML = `
                            <select name="status" id="status" style="width: 100%; height: 100%;">
                                <option class="me-4" value="Approved">Approved</option>
                                <option class="me-4" value="Rejected">Rejected</option>
                                <option class="me-4" value="Redo">Redo</option>
                            </select>
                            `;
                            var sendButton = row.querySelector('#send-btn');
                            sendButton.addEventListener('click', submitForm);
                            button.style.backgroundColor = "red";
                            button.textContent = "SEND";
                }
                
                
             }
            
        }).then(function(data) {
            console.log(data);
        });
    }; 
    document.addEventListener('click', function(event) {
        var button = event.target;
        if (button.classList.contains("undo-btn") && button.textContent === "Undo") {
            event.preventDefault();
            console.log("got in")
            var row = button.closest('tr'); 
                var data = {
                    'project_name': row.querySelector('td:nth-child(1)').innerText,
                    'username': row.querySelector('td:nth-child(2)').innerText,
                    'start_date': row.querySelector('td:nth-child(3)').innerText,
                    
                };

                fetch("{% url 'timesheet_manager' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(data)
                }).then(function(response) {
                    return response.json();
                }).then(function(data) {
                    if (data.message === "Update successful") {
                        button.textContent = "Send";
                        button.style.backgroundColor = "red";

                        // Find the status field and replace it with a select field
                        var statusField = row.querySelector('td:nth-child(7)');
                        statusField.innerHTML = `
                            <select name="status" id="status" style="width: 100%; height: 100%;">
                                <option class="me-4" value="Approved">Approved</option>
                                <option class="me-4" value="Rejected">Rejected</option>
                                <option class="me-4" value="Redo">Redo</option>
                            </select>
                            `;

                        // Set up event listener for the new "Send" button
                        var sendButton = row.querySelector('#send-btn');
                        sendButton.addEventListener('click', submitForm);
                    }
                });
            }
        });

    document.addEventListener('DOMContentLoaded', function() {
        var sendButton = document.getElementById("send-btn");
        sendButton.addEventListener('click', submitForm);
    });
</script>

{% endblock pageContent %}

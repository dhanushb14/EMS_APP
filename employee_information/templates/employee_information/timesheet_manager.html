{% extends "employee_information/base.html" %} {% block pageContent %}
<style>
    .input-large {
    width: 100%;
    font-size: 16px;
    padding: 10px;
    box-sizing: border-box;
}
    .highlight-row{
        background-color: #e0e0e0 !important;
        height: 20px !important;
        border-color: white;
        
        

    }

    
.highlight-row td {
height: 30px;
border-top: 1px solid transparent; /* Adjust this value */
border-bottom: 1px solid transparent; /* Adjust this value */
vertical-align: center; /* To align the text vertically in the middle */

padding: 0; /* Add this line */
}
    .italic-text {
        
        white-space: nowrap;
    }
    .spaced-table {
        border-collapse: separate;
        border-spacing: 0 5px;
    }
    .spaced-table th {
        color: white !important;
    }
    .button-group {
    display: flex;
    justify-content: flex-end;
    }

    .message-box {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: black;
        color: white;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .message-box.show {
        opacity: 1;
        display: block;
        animation: fadeOut 0.5s ease-in-out;
    }
    @keyframes fadeOut {
        0% {
            opacity: 1;
        }
        100% {
            opacity: 0;
        }
}
</style>
<div class="italic-text">
    <h2> Time Sheets</h2>
</div>
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card py-2" style="background-color: #dcd0ff;">
        <div class="d-flex justify-content-start align-items-center">
            <label for="start_date" class="me-2">Project Name: </label>
            <input type="text" id="project_name_filter" name="project_name" class="me-4">
            <button type="button" id="applyFilterBtn" class="btn btn-primary" disabled>Apply Filter</button>
        </div>
    </div>
</div>
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card">
        <div class="table-responsive">
            <form id="timeSheetForm">
            <table class="table table-bordered spaced-table">
                <colgroup>
                    <col width="15%">
                    <col width="11.5%">
                    <col width="11.5%">
                    <col width="11.5%">
                    <col width="11.5%">
                    <col width="11.5%">
                    <col width="11.5%">
                    <col width="20%">
                    <col width="8%">
                </colgroup>
                <thead style="height: 10px;" >
                    <tr style="background-color: grey;">
                        <th class="text-center ">Project name</th>
                        <th class="text-center ">Emp Name</th>
                        <th class="text-center ">Start Date</th>
                        <th class="text-center ">End Date</th>
                        <th class="text-center ">ST</th>
                        <th class="text-center ">OT</th>
                        <th class="text-center ">Status</th>
                        <th class="text-center ">Comment</th>
                        <th class="text-center "></th>
                    </tr>
                </thead>
                <tbody>
                    
                    {% for position in data %}    
                        <tr class="highlight-row" >
                        <td id='project_name' class=" text-center">{{ position.project_name }}</td>
                        
                        <td id='username' class=" text-center">{{ position.username }}</td>
                        <td  id='start_date' class=" text-center">{{ position.start_date }}</td>
                        <td  id='end_date' class=" text-center">{{ position.end_date }}</td>
                        <td  id='St' class=" text-center">{{ position.St }}</td>
                        <td  id='ot' class=" text-center">{{ position.ot }}</td>
                        {% if position.status == "Approved" %}
                        <td id='status' class="text-center">Approved</td>
                        {% elif position.status == "Rejected" %}
                        <td id='status' class="text-center">Rejected</td>
                        {% else %}
                        <td id="status" class="text-center">
                            <select name="status" id="status" style="width: 100%; height: 100%;">
                                <option class="me-4" value="Approved">Approved</option>
                                <option class="me-4" value="Rejected">Rejected</option>
                                 
                            </select>
                         </td>
                        {% endif %}
                        <td class="text-center">
                            
                            <input type="text" id="comment" name="comment" style="width: 100%;height: 100%;">
                             
                         </td>
                        <td class="px-2 py-3 text-center">
                           {% if position.status == "Approved" or position.status == "Rejected" %}
                           <button id="send-btn" class="undo-btn" style="background-color:green !important; color: white; border: none; padding: 3px 5px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); transition: background-color 0.3s;" >Undo</button>{% else %}
                           <button id="send-btn" onclick="submitForm(event)" style="background-color:red !important; color: white; border: none; padding: 3px 5px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); transition: background-color 0.3s;">SEND</button>{% endif %}
                            
             
                           <button id = "visibility" class="mdc-button mdc-button--raised p-1 icon-button filled-button--light mdc-ripple-upgraded edit-data" type="button" data-id="{{ position.username }}" data-project="{{ position.project_name }}" data-start_date="{{ position.start_date }}" data-end_date="{{ position.end_date }}" title="Edit">
                            <i class="material-icons mdc-button__icon">visibility</i>
                        </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        </form>
        <div id="pagination" style="text-align: right;">
            <span id="pageDisplay">Page 1</span>
            <button id="prevBtn" disabled><</button>
            <button id="nextBtn">></button>
        </div>
    </div>
</div>
<script>
    document.getElementById('project_name_filter').addEventListener('input', function() {
    var projectName = this.value;
    var applyFilterBtn = document.getElementById('applyFilterBtn');
    if (projectName.trim() !== '') {
        applyFilterBtn.disabled = false;
    } else {
        applyFilterBtn.disabled = true;
    }
});
    
    var currentPage = 0;
    var rowsPerPage = 10;
    var tableBody = document.querySelector('.table tbody');
    var rows = Array.from(tableBody.querySelectorAll('tr'));
function displayPage() {
    console.log('Current Page:', currentPage); // Add this line
    
    
    console.log('Rows:', rows); // Add this line
    var data_list = rows.slice(currentPage * rowsPerPage, (currentPage + 1) * rowsPerPage);
    console.log("here1")
    
    
    console.log('Data List:', data_list); // Add this line
    // Remove rows that are not in the new slice
    while (tableBody.firstChild) {
        tableBody.removeChild(tableBody.firstChild);
    }

    data_list.forEach(function(row) {
        tableBody.appendChild(row);
    });

    document.getElementById('pageDisplay').textContent = 'Page ' + (currentPage + 1);

    var prevBtn = document.getElementById('prevBtn');
    var nextBtn = document.getElementById('nextBtn');

    if (currentPage === 0) {
        prevBtn.disabled = true;
    } else {
        prevBtn.disabled = false;
    }

    if ((currentPage + 1) * rowsPerPage >= rows.length) {
        nextBtn.disabled = true;
    } else {
        nextBtn.disabled = false;
    }
}

document.getElementById('prevBtn').addEventListener('click', function() {
    console.log("prevbtn called")
    currentPage--;
    displayPage();
});

document.getElementById('nextBtn').addEventListener('click', function() {
    console.log("nextbtn called")
    console.log('Current Page before increment:', currentPage); // Add this line
    currentPage++;
    console.log('Current Page after increment:', currentPage); // Add this line
    displayPage();
});

// Call displayPage on page load
document.addEventListener('DOMContentLoaded', function() {
    displayPage();
});
    
    $('.edit-data').click(function() {
    var id = $(this).attr('data-id');
    var project = $(this).attr('data-project');
    var startDate = $(this).attr('data-start_date');
    var endDate = $(this).attr('data-end_date');
    
    // Call the uni_modal function with the appropriate parameters
    uni_modal("Edit TimeSheet", "{% url 'view_timesheet' %}?id=" + id + "&data-project=" + project + "&data-start_date=" + startDate + "&data-end_date=" + endDate, 'modal-lg');
});
    document.getElementById('applyFilterBtn').addEventListener('click', function() {
        var project_name = document.getElementById('project_name_filter').value;
        
        fetch("{% url 'timesheet_manager' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                'project_name': project_name,
                
            }) // Add closing parenthesis here
        }).then(function(response) {
            return response.json();
        }).then(function(data_list) { // Move the .then function call here
            
            var tableBody = document.querySelector('.table tbody');
            var currentPage = 0;
            var rowsPerPage = 10;

            function displayPage() {
                console.log("second displaypage callled")
                while (tableBody.firstChild) {
                    tableBody.removeChild(tableBody.firstChild);
                }

                var start = currentPage * rowsPerPage;
                var end = start + rowsPerPage;

                data_list.slice(start, end).forEach(function(item) {
                    $(document).on('click', '.edit-data', function() {
                        console.log("hey")
                        var id = $(this).attr('data-id');
                        var project = $(this).attr('data-project');
                        var startDate = $(this).attr('data-start_date');
                        var endDate = $(this).attr('data-end_date');
                        
                        // Call the uni_modal function with the appropriate parameters
                        uni_modal("Edit TimeSheet", "{% url 'view_timesheet' %}?id=" + id + "&data-project=" + project + "&data-start_date=" + startDate + "&data-end_date=" + endDate, 'modal-lg');
                    });
                    var row = document.createElement('tr');
                    console.log(item.project_name,item.username, item.start_date, item.end_date);

                    row.classList.add('highlight-row')
                    row.innerHTML = `
                        <td class="text-center">${item.project_name}</td>
                        <td class="text-center">${item.username}</td>
                        <td class="text-center">${item.start_date}</td>
                        <td class="text-center">${item.end_date}</td>
                        <td class="text-center">${item.St}</td>
                        <td class="text-center">${item.ot}</td>
                        <td class="text-center">
                            ${item.status == "Approved" || item.status == "Rejected" ? item.status : `
                                <select name="status" id="status" style="width: 100%; height: 100%;">
                                    <option class="me-4" value="Approved">Approved</option>
                                    <option class="me-4" value="Rejected">Rejected</option>
                                </select>
                            `}
                        </td>
                        <td class="text-center">
                            
                            <input type="text" id="comment" name="comment" style="width: 100%;height: 100%;">
                             
                         </td>
                        <td class="text-center">
                            ${item.status == "Approved" || item.status == "Rejected" ? 
                            `<button id="send-btn" class="undo-btn" style="background-color: green !important; color: white; border: none; padding: 3px 5px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); transition: background-color 0.3s;" disabled>SEND</button>` :
                            `<button id="send-btn" onclick="submitForm(event)" style="background-color: red !important; color: white; border: none; padding: 3px 5px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); transition: background-color 0.3s;">SEND</button>`}
                            <button id="visibility" class="mdc-button mdc-button--raised p-1 icon-button filled-button--light mdc-ripple-upgraded edit-data" type="button" data-id="${item.username}" data-project="${item.project_name}" data-start_date="${item.start_date}" data-end_date="${item.end_date}" title="Edit">
                                <i class="material-icons mdc-button__icon">visibility</i>
                            </button>
                        </td>
                        
                    `;
                    tableBody.appendChild(row);
                });

                document.getElementById('pageDisplay').textContent = 'Page ' + (currentPage + 1);

                var prevBtn = document.getElementById('prevBtn');
                var nextBtn = document.getElementById('nextBtn');

                if (currentPage === 0) {
                    prevBtn.disabled = true;
                } else {
                    prevBtn.disabled = false;
                }

                if (end >= data_list.length) {
                    nextBtn.disabled = true;
                } else {
                    nextBtn.disabled = false;
                }
            }

            displayPage();

            document.getElementById('prevBtn').addEventListener('click', function() {
                currentPage--;
                displayPage();
            });

            document.getElementById('nextBtn').addEventListener('click', function() {
                currentPage++;
                displayPage();
            });
        }).catch(function(error) {
            console.error('Error:', error);
        });
    });


    function submitForm(event) {
        event.preventDefault(); // Prevent form submission and page refresh

        var button = event.target;
        var row = button.parentNode.parentNode;
        var data = {
        'project_name': row.querySelector('td:nth-child(1)')?.innerText || '',
        'username': row.querySelector('td:nth-child(2)')?.innerText || '',
        'start_date': row.querySelector('td:nth-child(3)')?.innerText || '',
        'end_date': row.querySelector('td:nth-child(4)')?.innerText || '',
        'ST': row.querySelector('td:nth-child(5)')?.innerText || '',
        'OT': row.querySelector('td:nth-child(6)')?.innerText || '',
        'status': row.querySelector('td:nth-child(7) select')?.value || '',
        'comment': row.querySelector('td:nth-child(8) input')?.value || '',
        
    };

        fetch("{% url 'timesheet_manager' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        }).then(function(response) {
        return response.json();
        }).then(function(data) {
            if (data.message === "Update successful") {
                button.style.backgroundColor = "green";
                button.textContent = "Undo";

                // Find the status field and update it
                var statusField = row.querySelector('td:nth-child(7)');
                if (data.status){
                statusField.innerHTML = data.status;} // Assuming the server returns the new status
                else if (data.data){
                    statusField.innerHTML = data.data;}
                else {
                    statusField.innerHTML = `
                            <select name="status" id="status" style="width: 100%; height: 100%;">
                                <option class="me-4" value="Approved">Approved</option>
                                <option class="me-4" value="Rejected">Rejected</option>
                            </select>
                            `;
                            var sendButton = row.querySelector('#send-btn');
                            sendButton.addEventListener('click', submitForm);
                            button.style.backgroundColor = "red";
                            button.textContent = "SEND";
                }
                
                
             }
            
        }).then(function(data) {
            console.log(data);
        });
    }; 
    document.addEventListener('click', function(event) {
        var button = event.target;
        if (button.classList.contains("undo-btn") && button.textContent === "Undo") {
            event.preventDefault();
            console.log("got in")
            var row = button.closest('tr'); 
                var data = {
                    'project_name': row.querySelector('td:nth-child(1)').innerText,
                    'username': row.querySelector('td:nth-child(2)').innerText,
                    'start_date': row.querySelector('td:nth-child(3)').innerText,
                    
                };

                fetch("{% url 'timesheet_manager' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(data)
                }).then(function(response) {
                    return response.json();
                }).then(function(data) {
                    if (data.message === "Update successful") {
                        button.textContent = "Send";
                        button.style.backgroundColor = "red";

                        // Find the status field and replace it with a select field
                        var statusField = row.querySelector('td:nth-child(7)');
                        statusField.innerHTML = `
                            <select name="status" id="status" style="width: 100%; height: 100%;">
                                <option class="me-4" value="Approved">Approved</option>
                                <option class="me-4" value="Rejected">Rejected</option>
                            </select>
                            `;

                        // Set up event listener for the new "Send" button
                        var sendButton = row.querySelector('#send-btn');
                        sendButton.addEventListener('click', submitForm);
                    }
                });
            }
        });

    document.addEventListener('DOMContentLoaded', function() {
        var sendButton = document.getElementById("send-btn");
        sendButton.addEventListener('click', submitForm);
    });

</script>

{% endblock pageContent %} {% block ScriptBlock %}


{% endblock ScriptBlock %}
